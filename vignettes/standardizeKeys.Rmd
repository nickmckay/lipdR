---
title: "lipd Values standardization with ISO2k"
author: "Dave Edge"
date: "2023-01-13"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
devtools::load_all()
```

###Load Data

First we grab the ISO2k data and the standardization tables

```{r}
load("C:/Users/dce25/Downloads/iso2k1_0_1.RData")
#standardTables <- readRDS("C:/Users/dce25/Downloads/standardTables.RDS")
#standardTables now included in package data
```

###Check for valid `archiveType`

`isValidValue()` checks to see if all terms for a given key are valid lipd terms

```{r}
# print(TS)
isValidValue(TS, "archiveType")
```

the function returns a data frame showing invalid terms


Now we can standardize the invalid terms by looking for synonyms

`standardizeValue()` looks for matches from previous lipd entries and PaST terms which are know to be synonyms of valid lipd terms

```{r, warning=FALSE}
TSnew <- standardizeValue(TS, "paleoData_variableName")
```

the function was able to find matches for some, but not all invalid terms

The function returns the TS object (now `TSnew`) with corrections where possible

The user is given the option to make the suggested corrections or abort


###Check for valid `variableName`

Same process with a different key

```{r}
# print(TS)
invalidDF <- isValidValue(TS, "paleoData_variableName")

invalidDF
```

Wow, there a lot of invalid terms here

```{r}
TSnew <- standardizeValue(TS, "paleoData_variableName")
```

And this time we do have synonyms allowing for automated corrections to all invalid terms

Now, let's update the metadata based on our standard tables

```{r}
newMetadata <- updateMetaDataFromStandardTables(TSnew$TS, "paleoData_variableName")
```

This function returns the TS object with updated metadata as well as a data frame detailing the changes

```{r}
head(newMetadata$ChangesDF)
```

We see `TRUE` where the values remain the same and `NA` where the metadata keys were added or the values were updated

Now we can add notes to the TS object to track what has been updated

```{r}
metadataChangesDF <- newMetadata$ChangesDF
standardizeSynonymDF <- TSnew$synonymDF

TSfinal <- updateNotes(TSnew$TS, metadataChangesDF, standardizeSynonymDF)
```

We can grab a couple of examples to have a look

```{r}
TSfinal[[1]]$paleoData_notes
```

```{r}
TSfinal[[251]]$paleoData_notes
```
